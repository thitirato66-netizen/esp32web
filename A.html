<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 Web BLE App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="favicon.ico" />
  <link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body>
  <!-- Top Navigation -->
  <div class="topnav">
    <h1>ESP32 Web BLE Application</h1>
  </div>

  <!-- Main Content -->
  <div class="content">

    <!-- BLE Connection Card -->
    <div class="card-grid">
      <div class="card">
        <p>
          <button id="connectBleButton" class="connectButton">
            Connect to BLE Device
          </button>
          <button id="disconnectBleButton" class="disconnectButton">
            Disconnect BLE Device
          </button>
        </p>

        <p class="gray-label">
          BLE state:
          <strong>
            <span id="bleState" style="color:#d13a30;">Disconnected</span>
          </strong>
        </p>
      </div>
    </div>

    <!-- Data & Control Cards -->
    <div class="card-grid">

      <!-- Sensor Value -->
      <div class="card">
        <h2>Fetched Value</h2>
        <p class="reading">
          <span id="valueContainer">NaN</span>
        </p>
        <p class="gray-label">
          Last reading: <span id="timestamp"></span>
        </p>
      </div>

      <!-- GPIO Control -->
      <div class="card">
        <h2>Control GPIO 2</h2>
        <button id="onButton" class="onButton">ON</button>
        <button id="offButton" class="offButton">OFF</button>

        <p class="gray-label">
          Last value sent: <span id="valueSent"></span>
        </p>
      </div>

    </div>
  </div>
</body>

<script>
/* =======================
   DOM ELEMENTS
======================= */
const connectButton = document.getElementById("connectBleButton");
const disconnectButton = document.getElementById("disconnectBleButton");
const onButton = document.getElementById("onButton");
const offButton = document.getElementById("offButton");
const retrievedValue = document.getElementById("valueContainer");
const latestValueSent = document.getElementById("valueSent");
const bleStateContainer = document.getElementById("bleState");
const timestampContainer = document.getElementById("timestamp");

/* =======================
   BLE DEFINITIONS
======================= */
const deviceName = "APPLE";
const bleService = "19b10000-e8f2-537e-4f6c-d104768a1214";
const sensorCharacteristic = "19b10001-e8f2-537e-4f6c-d104768a1214";
const ledCharacteristic = "19b10002-e8f2-537e-4f6c-d104768a1214";

/* =======================
   GLOBAL VARIABLES
======================= */
let bleServer;
let bleServiceFound;
let sensorCharacteristicFound;

/* =======================
   EVENT LISTENERS
======================= */
connectButton.addEventListener("click", () => {
  if (isWebBluetoothEnabled()) {
    connectToDevice();
  }
});

disconnectButton.addEventListener("click", disconnectDevice);
onButton.addEventListener("click", () => writeOnCharacteristic(1));
offButton.addEventListener("click", () => writeOnCharacteristic(0));

/* =======================
   FUNCTIONS
======================= */

// Check Web Bluetooth Support
function isWebBluetoothEnabled() {
  if (!navigator.bluetooth) {
    bleStateContainer.innerHTML =
      "Web Bluetooth API is not available in this browser!";
    return false;
  }
  return true;
}

// Connect to BLE Device
function connectToDevice() {
  console.log("Initializing Bluetooth...");

  navigator.bluetooth.requestDevice({
    filters: [{ name: deviceName }],
    optionalServices: [bleService],
  })
  .then(device => {
    bleStateContainer.innerHTML = Connected to ${device.name};
    bleStateContainer.style.color = "#24af37";

    device.addEventListener(
      "gattservicedisconnected",
      onDisconnected
    );
    return device.gatt.connect();
  })
  .then(server => {
    bleServer = server;
    return bleServer.getPrimaryService(bleService);
  })
  .then(service => {
    bleServiceFound = service;
    return service.getCharacteristic(sensorCharacteristic);
  })
  .then(characteristic => {
    sensorCharacteristicFound = characteristic;
    characteristic.addEventListener(
      "characteristicvaluechanged",
      handleCharacteristicChange
    );
    characteristic.startNotifications();
    return characteristic.readValue();
  })
  .then(value => {
    retrievedValue.innerHTML =
      new TextDecoder().decode(value);
  })
  .catch(error => console.error(error));
}

// Handle Disconnect
function onDisconnected(event) {
  bleStateContainer.innerHTML = "Device disconnected";
  bleStateContainer.style.color = "#d13a30";
  console.log("Disconnected:", event.target.device.name);
}

// Handle Incoming Data
function handleCharacteristicChange(event) {
  const value = new TextDecoder().decode(event.target.value);
  retrievedValue.innerHTML = value;
  timestampContainer.innerHTML = getDateTime();
}

// Write GPIO Value
function writeOnCharacteristic(value) {
  if (!bleServer || !bleServer.connected) {
    alert("Bluetooth not connected!");
    return;
  }

  bleServiceFound.getCharacteristic(ledCharacteristic)
    .then(characteristic => {
      return characteristic.writeValue(
        new Uint8Array([value])
      );
    })
    .then(() => {
      latestValueSent.innerHTML = value;
    })
    .catch(error => console.error(error));
}

// Disconnect BLE
function disconnectDevice() {
  if (bleServer && bleServer.connected) {
    bleServer.disconnect();
    bleStateContainer.innerHTML = "Disconnected";
    bleStateContainer.style.color = "#d13a30";
  }
}

// Get Timestamp
function getDateTime() {
  const d = new Date();
  return d.toLocaleString("en-GB");
}
</script>
</html>